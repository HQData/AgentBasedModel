
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>driver &#8212; ABMHAP 2018.06 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for driver</h1><div class="highlight"><pre>
<span></span><span class="c1"># The United States Environmental Protection Agency through its Office of</span>
<span class="c1"># Research and Development has developed this software. The code is made</span>
<span class="c1"># publicly available to better communicate the research. All input data</span>
<span class="c1"># used fora given application should be reviewed by the researcher so</span>
<span class="c1"># that the model results are based on appropriate data for any given</span>
<span class="c1"># application. This model is under continued development. The model and</span>
<span class="c1"># data included herein do not represent and should not be construed to</span>
<span class="c1"># represent any Agency determination or policy.</span>
<span class="c1">#</span>
<span class="c1"># This file was written by Dr. Namdi Brandon</span>
<span class="c1"># ORCID: 0000-0001-7050-1538</span>
<span class="c1"># March 22, 2018</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This code runs the simulation for the Agent-Based Model of Human Activity Patterns \</span>
<span class="sd">(ABMHAP) module of the Life Cycle Human Exposure Model (LC-HEM) project. This code is \</span>
<span class="sd">the driver for seeing how well ABMHAP parameterized with empirical human behavior data from the \</span>
<span class="sd">Consolidated Human Activity Database (CHAD) compares to results seen in CHAD.</span>

<span class="sd">.. note::</span>
<span class="sd">    This code may be run in batches in order to run many households while conserving memory. That is, \</span>
<span class="sd">    instead of running 32 households at once (and keeping 32 households in memory), the program can \</span>
<span class="sd">    run 2 batches of 16 households (for a total of 32 household). This halves the amount of memory \</span>
<span class="sd">    used in the simulation compared to running the simulation of 1 batch of 32 households. We  \</span>
<span class="sd">    will shown how to run the code using &quot;batches&quot; below.</span>

<span class="sd">The driver can also be run in **parallel**. We will show how to do so below.</span>

<span class="sd">To run the code, do the following.</span>

<span class="sd">#. Set the simulation-centric parameters in driver_params.py</span>
<span class="sd">#. Run the code as</span>
<span class="sd">    \&gt; :literal:`python driver.py num_process num_hhld num_batch`</span>
<span class="sd">    where</span>
<span class="sd">        * :literal:`num_process` is the total number of cores (i.e, processing units) used in the simulation</span>
<span class="sd">        * :literal:`num_hhld` is the number of simulations to run per batch</span>
<span class="sd">        * :literal:`num_batch` is the number of batches used per core</span>

<span class="sd">The following are examples on how to run the code:</span>

<span class="sd">To run in **serial** with with 64 households per batch, 1 batch (implied)</span>

<span class="sd">\&gt; :literal:`python driver.py 1 64 1`</span>

<span class="sd">\&gt; :literal:`python driver.py 1 64`</span>

<span class="sd">To run in serial using 2 batches with 1 thread with 32 households per batch, 2 batches</span>

<span class="sd">\&gt; :literal:`python driver.py 1 32 2`</span>

<span class="sd">To run in **parallel** using 4 cores with 64 households total (16 household per core per batch), 1 batch (implied)</span>

<span class="sd">\&gt; :literal:`python driver.py 4 64 1`</span>

<span class="sd">\&gt; :literal:`python driver.py 4 64`</span>

<span class="sd">To run in parallel using 4 cores with 32 households per batch, 2 batches(8 households per core per batch)</span>

<span class="sd">\&gt; :literal:`python driver.py 4 32 2`</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ===========================================</span>
<span class="c1"># import</span>
<span class="c1"># ===========================================</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;..</span><span class="se">\\</span><span class="s1">source&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;..</span><span class="se">\\</span><span class="s1">run&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;..</span><span class="se">\\</span><span class="s1">processing&#39;</span><span class="p">)</span>

<span class="c1"># for plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># for parallelism</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>

<span class="c1"># timing capability</span>
<span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span>

<span class="c1"># mathematical capabilities</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># ABMHAP modules</span>
<span class="kn">import</span> <span class="nn">demography</span> <span class="k">as</span> <span class="nn">dmg</span>
<span class="kn">import</span> <span class="nn">my_globals</span> <span class="k">as</span> <span class="nn">mg</span>
<span class="kn">import</span> <span class="nn">driver_params</span> <span class="k">as</span> <span class="nn">dp</span>

<span class="kn">import</span> <span class="nn">chad_params</span><span class="o">,</span> <span class="nn">commute_from_work_trial</span><span class="o">,</span> <span class="nn">commute_to_work_trial</span><span class="o">,</span> <span class="nn">driver_result</span><span class="o">,</span> \
    <span class="n">eat_breakfast_trial</span><span class="p">,</span> <span class="n">eat_dinner_trial</span><span class="p">,</span> <span class="n">eat_lunch_trial</span><span class="p">,</span> <span class="n">omni_trial</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> \
    <span class="n">sleep_trial</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span> <span class="n">work_trial</span>

<span class="kn">import</span> <span class="nn">chad_demography_adult_non_work</span> <span class="k">as</span> <span class="nn">cdanw</span>
<span class="kn">import</span> <span class="nn">chad_demography_adult_work</span> <span class="k">as</span> <span class="nn">cdaw</span>
<span class="kn">import</span> <span class="nn">chad_demography_child_school</span> <span class="k">as</span> <span class="nn">cdcs</span>
<span class="kn">import</span> <span class="nn">chad_demography_child_young</span> <span class="k">as</span> <span class="nn">cdcy</span>

<span class="c1"># ===========================================</span>
<span class="c1"># constants</span>
<span class="c1"># ===========================================</span>
<span class="c1"># this chooses the correct trial to run</span>
<span class="n">TRIAL_2_CONSTRUCTOR</span> <span class="o">=</span> <span class="p">{</span> <span class="n">trial</span><span class="o">.</span><span class="n">COMMUTE_FROM_WORK</span><span class="p">:</span> <span class="n">commute_from_work_trial</span><span class="o">.</span><span class="n">Commute_From_Work_Trial</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">COMMUTE_TO_WORK</span><span class="p">:</span> <span class="n">commute_to_work_trial</span><span class="o">.</span><span class="n">Commute_To_Work_Trial</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">EAT_BREAKFAST</span><span class="p">:</span> <span class="n">eat_breakfast_trial</span><span class="o">.</span><span class="n">Eat_Breakfast_Trial</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">EAT_DINNER</span><span class="p">:</span> <span class="n">eat_dinner_trial</span><span class="o">.</span><span class="n">Eat_Dinner_Trial</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">EAT_LUNCH</span><span class="p">:</span> <span class="n">eat_lunch_trial</span><span class="o">.</span><span class="n">Eat_Lunch_Trial</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">SLEEP</span><span class="p">:</span> <span class="n">sleep_trial</span><span class="o">.</span><span class="n">Sleep_Trial</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">WORK</span><span class="p">:</span> <span class="n">work_trial</span><span class="o">.</span><span class="n">Work_Trial</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">OMNI</span><span class="p">:</span> <span class="n">omni_trial</span><span class="o">.</span><span class="n">Omni_Trial</span><span class="p">,</span>
                        <span class="p">}</span>

<span class="c1"># given a trial, this obtains the respective CHAD parameters</span>
<span class="n">TRIAL_2_CHAD_PARAMS</span> <span class="o">=</span> <span class="p">{</span> <span class="n">trial</span><span class="o">.</span><span class="n">COMMUTE_FROM_WORK</span><span class="p">:</span> <span class="n">chad_params</span><span class="o">.</span><span class="n">COMMUTE_FROM_WORK</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">COMMUTE_TO_WORK</span><span class="p">:</span> <span class="n">chad_params</span><span class="o">.</span><span class="n">COMMUTE_TO_WORK</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">EAT_BREAKFAST</span><span class="p">:</span> <span class="n">chad_params</span><span class="o">.</span><span class="n">EAT_BREAKFAST</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">EAT_DINNER</span><span class="p">:</span> <span class="n">chad_params</span><span class="o">.</span><span class="n">EAT_DINNER</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">EAT_LUNCH</span><span class="p">:</span> <span class="n">chad_params</span><span class="o">.</span><span class="n">EAT_LUNCH</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">SLEEP</span><span class="p">:</span> <span class="n">chad_params</span><span class="o">.</span><span class="n">SLEEP</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">WORK</span><span class="p">:</span> <span class="n">chad_params</span><span class="o">.</span><span class="n">WORK</span><span class="p">,</span>
                        <span class="n">trial</span><span class="o">.</span><span class="n">OMNI</span><span class="p">:</span> <span class="n">chad_params</span><span class="o">.</span><span class="n">OMNI</span><span class="p">,</span>
                        <span class="p">}</span>

<span class="c1"># ===========================================</span>
<span class="c1"># functions</span>
<span class="c1"># ===========================================</span>

<div class="viewcode-block" id="create_trials"><a class="viewcode-back" href="../driver.html#driver.create_trials">[docs]</a><span class="k">def</span> <span class="nf">create_trials</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">num_hours</span><span class="p">,</span> <span class="n">num_min</span><span class="p">,</span> <span class="n">trial_code</span><span class="p">,</span> <span class="n">chad_activity_params</span><span class="p">,</span> \
                  <span class="n">demographic</span><span class="p">,</span> <span class="n">num_people</span><span class="p">,</span> <span class="n">do_minute_by_minute</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the input data for each household in the simulation.</span>

<span class="sd">    :param int num_hhld: the number of households simulated</span>
<span class="sd">    :param int num_days: the number of days in the simulation</span>
<span class="sd">    :param int num_hours: the number of additional hours</span>
<span class="sd">    :param int num_min: the number of additional minutes</span>
<span class="sd">    :param int trial_code: the trial identifier</span>
<span class="sd">    :param chad_params.CHAD_params chad_activity_params: the activity parameters \</span>
<span class="sd">    used to sample &quot;good&quot; CHAD data</span>

<span class="sd">    :param int demographic: the demographic identifier</span>
<span class="sd">    :param int num_people: the number of people per household</span>
<span class="sd">    :param bool do_minute_by_minute: a flag for how the time steps progress in the scheduler</span>
<span class="sd">    :param bool do_print: flag whether to print messages to the console</span>

<span class="sd">    :returns: input data where each entry corresponds to the input \</span>
<span class="sd">    for the respective household in the simulation</span>
<span class="sd">    :rtype: list of :class:`trial.Trial`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load the parameters necessary for the runs comparing the ABMHAP to CHAD</span>
    <span class="c1"># run the simulation using default parameters</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">Params</span><span class="p">(</span><span class="n">num_days</span><span class="o">=</span><span class="n">num_days</span><span class="p">,</span> <span class="n">num_hours</span><span class="o">=</span><span class="n">num_hours</span><span class="p">,</span> <span class="n">num_min</span><span class="o">=</span><span class="n">num_min</span><span class="p">,</span> \
                                <span class="n">num_people</span><span class="o">=</span><span class="n">num_people</span><span class="p">,</span> <span class="n">do_minute_by_minute</span><span class="o">=</span><span class="n">do_minute_by_minute</span><span class="p">)</span> \
                  <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">)]</span>

    <span class="c1"># print message</span>
    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;initializing trials...&#39;</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># create the conditions for each trial</span>
    <span class="c1">#</span>

    <span class="c1"># start timing</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># initialize the simulation inputs</span>
    <span class="n">trials</span> <span class="o">=</span> <span class="n">initialize_trials</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">trial_code</span><span class="p">,</span> <span class="n">chad_activity_params</span><span class="p">,</span> <span class="n">demographic</span><span class="p">)</span>

    <span class="c1"># end timing</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># calculate the elapsed time</span>
    <span class="n">dt_elapsed</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

    <span class="c1"># print message</span>
    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;elapsed time to initialize </span><span class="si">%d</span><span class="s1"> trials:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s1"> [s]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">dt_elapsed</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">trials</span></div>

<div class="viewcode-block" id="delete_batch_files"><a class="viewcode-back" href="../driver.html#driver.delete_batch_files">[docs]</a><span class="k">def</span> <span class="nf">delete_batch_files</span><span class="p">(</span><span class="n">fname_base</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function deletes the batch files.</span>

<span class="sd">    :param str fname_base: the file name for the files without the &quot;.pkl&quot;, that are the basis of the batch files \</span>
<span class="sd">    that will be deleted</span>
<span class="sd">    :param int num_batch: the number of batches used in the code run</span>

<span class="sd">    :returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># delete all batch files marked by fname_base</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batch</span><span class="p">):</span>

        <span class="c1"># add the respective ending to fname_base for appropriate batch number</span>
        <span class="n">f_ending</span>    <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">F_BATCH_ENDING</span> <span class="o">%</span> <span class="n">i</span>
        <span class="n">fname</span>       <span class="o">=</span> <span class="n">fname_base</span> <span class="o">+</span> <span class="n">f_ending</span>

        <span class="c1"># if the path exists (which it should), delete the file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="get_batch_filenames"><a class="viewcode-back" href="../driver.html#driver.get_batch_filenames">[docs]</a><span class="k">def</span> <span class="nf">get_batch_filenames</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This file gets the file names for the batch saves.</span>

<span class="sd">    :param str fpath: the name of the directory that the batch file names are stored</span>
<span class="sd">    :param str fname: the name of the file to save (.pkl)</span>

<span class="sd">    :returns: the batched file names</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># list all of the file names in the directory that end with &#39;.pkl&#39;</span>
    <span class="n">fname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span>  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">mg</span><span class="o">.</span><span class="n">check_filename_extension</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mg</span><span class="o">.</span><span class="n">EXTENSION_PKL</span><span class="p">)</span> <span class="p">]</span>

    <span class="c1"># get the file names for the data that corresponds to batch files</span>
    <span class="n">fname_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fname_list</span> <span class="k">if</span> <span class="n">is_batch_file</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mg</span><span class="o">.</span><span class="n">EXTENSION_PKL</span><span class="p">)</span> <span class="p">]</span>

    <span class="c1"># take away the leading &#39;\\&#39;</span>
    <span class="n">fname_temp</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># get the index of where the .pkl, .pickle is</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">fname_temp</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="c1"># get the file name before the &#39;.&#39;</span>
    <span class="n">fname_temp</span> <span class="o">=</span> <span class="n">fname_temp</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># get the file names that are part of the batch</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\\</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fname_list</span> <span class="k">if</span> <span class="n">fname_temp</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="get_chad_demo"><a class="viewcode-back" href="../driver.html#driver.get_chad_demo">[docs]</a><span class="k">def</span> <span class="nf">get_chad_demo</span><span class="p">(</span><span class="n">demographic</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the demographic, this function returns the respective CHAD_demography object.</span>

<span class="sd">    :param int demographic: the demography identifier</span>

<span class="sd">    :returns: the respective CHAD_demography object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chooser</span> <span class="o">=</span> <span class="p">{</span><span class="n">dmg</span><span class="o">.</span><span class="n">ADULT_WORK</span><span class="p">:</span> <span class="n">cdaw</span><span class="o">.</span><span class="n">CHAD_demography_adult_work</span><span class="p">(),</span>
               <span class="n">dmg</span><span class="o">.</span><span class="n">ADULT_NON_WORK</span><span class="p">:</span> <span class="n">cdanw</span><span class="o">.</span><span class="n">CHAD_demography_adult_non_work</span><span class="p">(),</span>
               <span class="n">dmg</span><span class="o">.</span><span class="n">CHILD_SCHOOL</span><span class="p">:</span> <span class="n">cdcs</span><span class="o">.</span><span class="n">CHAD_demography_child_school</span><span class="p">(),</span>
               <span class="n">dmg</span><span class="o">.</span><span class="n">CHILD_YOUNG</span><span class="p">:</span> <span class="n">cdcy</span><span class="o">.</span><span class="n">CHAD_demography_child_young</span><span class="p">(),</span>
               <span class="p">}</span>

    <span class="k">return</span> <span class="n">chooser</span><span class="p">[</span><span class="n">demographic</span><span class="p">]</span></div>

<div class="viewcode-block" id="get_cmd_line_params"><a class="viewcode-back" href="../driver.html#driver.get_cmd_line_params">[docs]</a><span class="k">def</span> <span class="nf">get_cmd_line_params</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function gets the parameters from the command line.</span>

<span class="sd">    The order of arguments to be read on the command line in order:</span>

<span class="sd">    #. the number of processors (threads)</span>
<span class="sd">    #. the number of households per batch</span>
<span class="sd">    #. the number of batches</span>

<span class="sd">    :returns: the number of processors, the, the total number of households to simulate, the number of batches</span>
<span class="sd">    :rtype: int, int, int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#indices</span>
    <span class="n">IDX_NUM_PROCESS</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">IDX_NUM_HHLD</span>    <span class="o">=</span> <span class="mi">2</span>
    <span class="n">IDX_NUM_BATCH</span>   <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># the number of command line arguments + 1</span>
    <span class="n">N_MAX</span>   <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># the number of arguments on the command line</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># the error message if the something is wrong on the command line</span>
    <span class="n">msg_error</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">ERROR. Did not specify the number of processors, number of households! Quitting...&#39;</span>

    <span class="c1"># check to see if the the number of arguments is the full amount. If batch size is not entered, then it is \</span>
    <span class="c1"># assumed to be the value 1</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">&gt;=</span> <span class="n">N_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="n">N_MAX</span><span class="p">)</span>

    <span class="c1"># check to make sure the command line argument count is acceptable</span>
    <span class="k">assert</span> <span class="n">condition</span><span class="p">,</span> <span class="n">msg_error</span>

    <span class="c1"># check to see if the the number of arguments is the full amount. If batch size is not entered, then it is \</span>
    <span class="c1"># assumed to be the value 1</span>

    <span class="n">num_process</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">IDX_NUM_PROCESS</span><span class="p">]</span>
    <span class="n">num_hhld</span>    <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">IDX_NUM_HHLD</span><span class="p">]</span>

    <span class="c1"># all of the entries were entered on the command line</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="n">N_MAX</span><span class="p">:</span>
        <span class="n">num_batch</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">IDX_NUM_BATCH</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># default batch size</span>
        <span class="n">num_batch</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># convert the entries into integers</span>
    <span class="n">num_process</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_process</span><span class="p">)</span>
    <span class="n">num_hhld</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">)</span>
    <span class="n">num_batch</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_batch</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">num_process</span><span class="p">,</span> <span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_batch</span></div>

<div class="viewcode-block" id="get_current_batch_size"><a class="viewcode-back" href="../driver.html#driver.get_current_batch_size">[docs]</a><span class="k">def</span> <span class="nf">get_current_batch_size</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns the number of households for the current batch if the total</span>
<span class="sd">    number of households is a multiple of the number of batches. Each batch</span>
<span class="sd">    contains max_batch_size amount of households.</span>
<span class="sd">    However, if not, the last batch will be smaller than the number of the max_batch_size.</span>

<span class="sd">    :param int num_hhld: the total amount of households in the simulation</span>
<span class="sd">    :param int idx: the index of the current batch number</span>
<span class="sd">    :param int max_batch_size: the maximum number of households per batch</span>

<span class="sd">    :returns: the current batch size</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the total number of households remaining to simulate</span>
    <span class="n">hhld_remaining</span> <span class="o">=</span> <span class="n">num_hhld</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">max_batch_size</span>

    <span class="c1"># calculate the batch size to be the minimum of the number of households left to simulate OR the</span>
    <span class="c1"># max_batch_size</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hhld_remaining</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch_size</span></div>

<div class="viewcode-block" id="get_fnames"><a class="viewcode-back" href="../driver.html#driver.get_fnames">[docs]</a><span class="k">def</span> <span class="nf">get_fnames</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">demographic</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a directory, this function creates the file names that will be used</span>
<span class="sd">    to save the ABMHAP trials (input) and the ABMHAP data (output) according</span>
<span class="sd">    to the respective demographic.</span>

<span class="sd">    :param str fpath: the directory in which to save the files</span>
<span class="sd">    :param int demographic: the demography identifier</span>
<span class="sd">    :param int num_days: the number of days in the simulation</span>
<span class="sd">    :param int N: the total number of households</span>
<span class="sd">    :param bool do_print: a flag to indicate whether (if True) or not \</span>
<span class="sd">    (if False) to print a message to the screen</span>

<span class="sd">    :returns: the file name to save the trials data (&quot;.pkl&quot; extension); \</span>
<span class="sd">    the file name to save the data (&quot;.pkl&quot; extension&quot;), \</span>
<span class="sd">    the file name to save the the basis (no &quot;.pkl&quot; extension) of the file \</span>
<span class="sd">    name to save the trials data, \</span>
<span class="sd">    the basis (no &quot;.pkl&quot; extension) of the file name to save the ABMHAP output data</span>
<span class="sd">    :rtype: str, str, str, str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the path to save the the data</span>
    <span class="n">fpath_save</span>      <span class="o">=</span> <span class="n">set_save_path</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span>

    <span class="c1"># choose the file names for the given demographic</span>
    <span class="n">chooser_fname</span>   <span class="o">=</span> <span class="p">{</span> <span class="n">dmg</span><span class="o">.</span><span class="n">ADULT_WORK</span><span class="p">:</span> <span class="p">(</span><span class="n">fpath_save</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">trials_adult_work.pkl&#39;</span><span class="p">,</span> \
                                         <span class="n">fpath_save</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">data_adult_work.pkl&#39;</span><span class="p">),</span>
                        <span class="n">dmg</span><span class="o">.</span><span class="n">ADULT_NON_WORK</span><span class="p">:</span> <span class="p">(</span><span class="n">fpath_save</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">trials_adult_non_work.pkl&#39;</span><span class="p">,</span> \
                                             <span class="n">fpath_save</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">data_adult_non_work.pkl&#39;</span><span class="p">),</span>
                        <span class="n">dmg</span><span class="o">.</span><span class="n">CHILD_SCHOOL</span><span class="p">:</span> <span class="p">(</span><span class="n">fpath_save</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">trials_child_school.pkl&#39;</span><span class="p">,</span> \
                                           <span class="n">fpath_save</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">data_child_school.pkl&#39;</span><span class="p">),</span>
                        <span class="n">dmg</span><span class="o">.</span><span class="n">CHILD_YOUNG</span><span class="p">:</span> <span class="p">(</span><span class="n">fpath_save</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">trials_child_young.pkl&#39;</span><span class="p">,</span> \
                                          <span class="n">fpath_save</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">data_child_young.pkl&#39;</span><span class="p">),</span>
                        <span class="p">}</span>

    <span class="c1"># get the file name of the trials and data, respectively</span>
    <span class="n">fname_trials</span><span class="p">,</span> <span class="n">fname_data</span> <span class="o">=</span> <span class="n">chooser_fname</span><span class="p">[</span><span class="n">demographic</span><span class="p">]</span>

    <span class="c1">#</span>
    <span class="c1"># Strip the &quot;.pkl&quot; at the end of the file name ino order to do batch saving</span>
    <span class="c1">#</span>
    <span class="n">fname_trials_base</span>   <span class="o">=</span> <span class="n">fname_trials</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">fname_data_base</span>     <span class="o">=</span> <span class="n">fname_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># print the name of fname_trials_base and fname_data_base</span>
    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trials base:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">data base:</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">fname_data_base</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fname_trials</span><span class="p">,</span> <span class="n">fname_data</span><span class="p">,</span> <span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">fname_data_base</span></div>

<div class="viewcode-block" id="get_loaded_trials_for_batch"><a class="viewcode-back" href="../driver.html#driver.get_loaded_trials_for_batch">[docs]</a><span class="k">def</span> <span class="nf">get_loaded_trials_for_batch</span><span class="p">(</span><span class="n">loaded_trials</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function extracts the household input information from the pre-loaded</span>
<span class="sd">    input data for the respective batch.</span>

<span class="sd">    :param loaded_trials: input data needed for the simulation</span>
<span class="sd">    :type loaded_trials: list of :class:`trial.Trial`</span>
<span class="sd">    :param int i: the current batch number</span>
<span class="sd">    :param int batch_size: the number of households in the batch</span>

<span class="sd">    :returns: the input data that corresponds to the batch number</span>
<span class="sd">    :rtype: list of :class:`trial.Trial`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the start index of the trials for the current batch</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>

    <span class="c1"># the ending index of the trials for the current batch</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_trials</span><span class="p">))</span>

    <span class="c1"># get the trials that correspond to the current batch</span>
    <span class="n">trials</span> <span class="o">=</span> <span class="n">loaded_trials</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">trials</span></div>

<div class="viewcode-block" id="get_max_batch_size"><a class="viewcode-back" href="../driver.html#driver.get_max_batch_size">[docs]</a><span class="k">def</span> <span class="nf">get_max_batch_size</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns the maximum number of households</span>
<span class="sd">    simulated per batch.</span>

<span class="sd">    :param int num_hhld: the total number of households to simulate</span>
<span class="sd">    :param int num_batch: the number of batches</span>

<span class="sd">    :returns: the number of households to simulate per batch</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the batch size</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_hhld</span> <span class="o">/</span> <span class="n">num_batch</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch_size</span></div>

<div class="viewcode-block" id="get_results"><a class="viewcode-back" href="../driver.html#driver.get_results">[docs]</a><span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="n">diaries</span><span class="p">,</span> <span class="n">trials</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes the output and input from the simulation and converts</span>
<span class="sd">    the data into the appropriate output and input types.</span>

<span class="sd">    :param diaries: each activity diary (output) in the Monte-Carlo simulation</span>
<span class="sd">    :type diaries: list of :class:`diary.Diary`</span>
<span class="sd">    :param trials: the input data for each household simulation.</span>
<span class="sd">    :type trials: list of :class:`trial.Trial`</span>

<span class="sd">    :returns: the output, the input</span>
<span class="sd">    :rtype: :class:`driver_result.Driver_Result`, list of :class:`params.Params`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get the demographic</span>
    <span class="n">demographic</span> <span class="o">=</span> <span class="n">trials</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">demographic</span>

    <span class="c1"># store the CHAD parameters</span>
    <span class="n">chad_param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">sampling_params</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">]</span>

    <span class="c1"># store the results of the simulations in an object</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">driver_result</span><span class="o">.</span><span class="n">Driver_Result</span><span class="p">(</span><span class="n">diaries</span><span class="o">=</span><span class="n">diaries</span><span class="p">,</span> <span class="n">chad_param_list</span><span class="o">=</span><span class="n">chad_param_list</span><span class="p">,</span> <span class="n">demographic</span><span class="o">=</span><span class="n">demographic</span><span class="p">)</span>

    <span class="c1"># adding this for testing</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">param_list</span></div>

<div class="viewcode-block" id="initialize_trials"><a class="viewcode-back" href="../driver.html#driver.initialize_trials">[docs]</a><span class="k">def</span> <span class="nf">initialize_trials</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">trial_code</span><span class="p">,</span> <span class="n">chad_activity_params</span><span class="p">,</span> <span class="n">demographic</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function initializes the trials (input parameters) for the simulation.</span>

<span class="sd">    :param param_list: contains information on how to initialize the \</span>
<span class="sd">    simulation for each household.</span>
<span class="sd">    :type pram_list: list of :class:`params.Params`</span>

<span class="sd">    :param int trial_code: the code of what trial to run</span>
<span class="sd">    :param chad_params.CHAD_params chad_activity_params: the activity parameters used to sample &quot;good&quot; CHAD data</span>
<span class="sd">    :param int demographic: this is the code for what demographic to run</span>

<span class="sd">    :returns: the initialized simulation scenarios</span>
<span class="sd">    :rtype: list of :class:`trial.Trial`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">trials</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="c1"># create and initialize each trial</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>

        <span class="c1"># choose the correct trial constructor</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">TRIAL_2_CONSTRUCTOR</span><span class="p">[</span><span class="n">trial_code</span><span class="p">]</span>

        <span class="c1"># create the trial object using the constructor f()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">chad_activity_params</span><span class="p">,</span> <span class="n">demographic</span><span class="p">)</span>

        <span class="n">t</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="c1"># add the initialized trial to the list of trials to do</span>
        <span class="n">trials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trials</span></div>

<div class="viewcode-block" id="is_batch_file"><a class="viewcode-back" href="../driver.html#driver.is_batch_file">[docs]</a><span class="k">def</span> <span class="nf">is_batch_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">extensions</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function indicates whether or not the filename is a batch file. For example,</span>
<span class="sd">    given a file name called filename_b0000.pkl will return True. On the other hand,</span>
<span class="sd">    filename.pkl will return False.</span>

<span class="sd">    :param str fname: the file name</span>
<span class="sd">    :param extensions: the file extensions for the file name</span>
<span class="sd">    :type extensions: str, list of str</span>

<span class="sd">    :returns: flag indicating whether the file name is a batch file</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># remove the pickle file name extension</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span> <span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extensions</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fname</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># split the string about the &#39;_&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

    <span class="c1"># the last item corresponds to the ending of the string</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># if the sting starts with a &#39;b&#39; and the rest can be an integer,</span>
    <span class="c1"># the file was a batch file in the format (&#39;filename_b0000.pkl&#39;)</span>
    <span class="c1"># Thus, return True</span>
    <span class="n">ok</span> <span class="o">=</span>  <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ok</span></div>

<div class="viewcode-block" id="load_trials_for_batches"><a class="viewcode-back" href="../driver.html#driver.load_trials_for_batches">[docs]</a><span class="k">def</span> <span class="nf">load_trials_for_batches</span><span class="p">(</span><span class="n">fname_load_trials_base</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">,</span> <span class="n">do_print</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     This function loads pre-existing trials data.</span>

<span class="sd">     :param str fname_load_trials: the filename (.pkl) of the trials data to load</span>
<span class="sd">     :param int num_batch: the number of batches</span>
<span class="sd">     :param bool do_print: a flag to indicate whether or not to print a message to \</span>
<span class="sd">     screen about the logistics of loading the data</span>

<span class="sd">     :returns: the input data that has been loaded, \</span>
<span class="sd">     the file name for the input data, \</span>
<span class="sd">     the batch size</span>
<span class="sd">     :rtype: list of :class:`trial.Trial`, str, int</span>
<span class="sd">     &quot;&quot;&quot;</span>

    <span class="c1"># the name of the file names for the pre-existing trial data</span>
    <span class="n">fname_load_trials</span> <span class="o">=</span> <span class="n">fname_load_trials_base</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span>

    <span class="c1"># start timing</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># load the trials</span>
    <span class="n">trials</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname_load_trials</span><span class="p">)</span>

    <span class="c1"># end timing</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># the elapsed time</span>
    <span class="n">dt_elapsed</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

    <span class="c1"># the number of households</span>
    <span class="n">num_hhld</span>    <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>

    <span class="c1"># the maximum number of households per batch</span>
    <span class="n">batch_size</span>  <span class="o">=</span> <span class="n">get_max_batch_size</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">loaded trials from</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname_load_trials</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;elapsed time to load </span><span class="si">%d</span><span class="s1"> trials:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s1"> [s]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">dt_elapsed</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">trials</span><span class="p">,</span> <span class="n">fname_load_trials</span><span class="p">,</span> <span class="n">batch_size</span></div>

<div class="viewcode-block" id="print_end"><a class="viewcode-back" href="../driver.html#driver.print_end">[docs]</a><span class="k">def</span> <span class="nf">print_end</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the elapsed time for the simulation message.</span>

<span class="sd">    :param float elapsed_time: the elapsed time for the simulation [seconds]</span>
<span class="sd">    :returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------ Finished ----------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;elapsed time: </span><span class="si">%.2f</span><span class="s1">[s]&#39;</span> <span class="o">%</span> <span class="n">elapsed_time</span><span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="print_start"><a class="viewcode-back" href="../driver.html#driver.print_start">[docs]</a><span class="k">def</span> <span class="nf">print_start</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the message about starting the simulation.</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------ Starting ----------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="print_starting_info"><a class="viewcode-back" href="../driver.html#driver.print_starting_info">[docs]</a><span class="k">def</span> <span class="nf">print_starting_info</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">num_process</span><span class="p">,</span> <span class="n">total_cpus</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print information before the beginning of the simulation.</span>

<span class="sd">    :param int num_hhld: the total number of households</span>
<span class="sd">    :param int batch_size: the maximum number of households to simulate per batch</span>
<span class="sd">    :param int num_hhld_per_batch: the number of households per batch</span>
<span class="sd">    :param num_days: the number of days in the simulation</span>
<span class="sd">    :param num_process: the number of processors used</span>
<span class="sd">    :param total_cpus: the total amount of potential CPUs available.</span>

<span class="sd">    :returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of households: </span><span class="si">%d</span><span class="se">\t\t</span><span class="s1">number of days per simulation: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of batches: </span><span class="si">%d</span><span class="se">\t\t\t</span><span class="s1">maximum number of households per batch: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;using </span><span class="si">%d</span><span class="s1"> out of </span><span class="si">%d</span><span class="s1"> CPU processors&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_process</span><span class="p">,</span> <span class="n">total_cpus</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="run"><a class="viewcode-back" href="../driver.html#driver.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">num_process</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function runs each simulation (in serial or parallel).</span>

<span class="sd">    :param int num_process: the number of processors to use</span>
<span class="sd">    :param trials: the input for each simulation</span>
<span class="sd">    :type trials: list of :class:`trial.Trial`</span>
<span class="sd">    :param bool do_print: a flag indicating whether to print (if True) or not (if False)</span>

<span class="sd">    :returns: the results of the simulations, the input parameters</span>
<span class="sd">    :rtype: diary_result.Diary_result, list of :class:`params.Params`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># close all plots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="c1"># start timing</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting...&#39;</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># run in serial</span>
    <span class="c1">#</span>

    <span class="k">if</span> <span class="n">num_process</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># this test prints the parameters for each agent in the trial</span>
        <span class="n">diaries</span> <span class="o">=</span> <span class="n">run_serial</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># run in parallel</span>
    <span class="c1">#</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diaries</span> <span class="o">=</span> <span class="n">run_parallel</span><span class="p">(</span><span class="n">num_process</span><span class="p">,</span> <span class="n">trials</span><span class="p">)</span>

    <span class="c1"># record the elapsed simulation time</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">total_simulation_time</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

    <span class="c1"># print the elapsed simulation time</span>
    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;elapsed time for driver.run():</span><span class="se">\t</span><span class="si">%.3f</span><span class="s1"> [s]&#39;</span> <span class="o">%</span> <span class="n">total_simulation_time</span><span class="p">)</span>

    <span class="c1"># get the results</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">param_list</span> <span class="o">=</span> <span class="n">get_results</span><span class="p">(</span><span class="n">diaries</span><span class="p">,</span> <span class="n">trials</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">param_list</span></div>

<div class="viewcode-block" id="run_batch"><a class="viewcode-back" href="../driver.html#driver.run_batch">[docs]</a><span class="k">def</span> <span class="nf">run_batch</span><span class="p">(</span><span class="n">num_batch</span><span class="p">,</span> <span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_process</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">num_hours</span><span class="p">,</span> <span class="n">num_min</span><span class="p">,</span> <span class="n">trial_code</span><span class="p">,</span> <span class="n">chad_activity_params</span><span class="p">,</span> \
              <span class="n">demographic</span><span class="p">,</span> <span class="n">num_people</span><span class="p">,</span> <span class="n">do_minute_by_minute</span><span class="p">,</span> <span class="n">do_print</span><span class="p">,</span> <span class="n">do_save</span><span class="p">,</span> \
              <span class="n">fpath</span><span class="p">,</span> <span class="n">do_load_trials</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fname_load_trials_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the simulation in batches.</span>

<span class="sd">    :param int num_batch: the number of batches</span>
<span class="sd">    :param int num_hhld: the total number of households to simulate</span>
<span class="sd">    :param int num_process: the number of processors used</span>
<span class="sd">    :param int num_days: the number of days in the simulation</span>
<span class="sd">    :param int num_hours: the number of additional hours in the simulation</span>
<span class="sd">    :param int num_min: the number of additional minutes in the simulation</span>
<span class="sd">    :param int trial_code: the identifier for the trial being run</span>
<span class="sd">    :param chad_params.CHAD_params chad_activity_params: the activity parameters used to sample &quot;good&quot; CHAD data</span>
<span class="sd">    :param int demographic: the demographic identifier</span>
<span class="sd">    :param bool do_print: a flag indicating whether to print (if True) or not (if False)</span>

<span class="sd">    :param bool do_save: flag to save the output</span>
<span class="sd">    :param str fname_trials_base: the file name for the trials without the .pkl, which will be used for saving the \</span>
<span class="sd">    trial information (.pkl)</span>
<span class="sd">    :param str fname_data_base: the file name for the ABMHAP without the .pkl, which will be used for saving the \</span>
<span class="sd">    trial information (.pkl)</span>
<span class="sd">    :param bool do_load_trials: indicating whether (if True) or not (if False) to load trials from a saved \</span>
<span class="sd">    file instead of creating a new set of trials</span>
<span class="sd">    :param str fname_load_trials_base: the file name for the ABMHAP trials without the .pkl, which will be used for \</span>
<span class="sd">    saving the trial information (.pkl)</span>

<span class="sd">    :returns: the file name of the input data, \</span>
<span class="sd">    the file name of the output data, \</span>
<span class="sd">    the file name of the input data (no &quot;.pkl&quot;), \</span>
<span class="sd">    the file name of the output data (no &quot;.pkl&quot;)</span>

<span class="sd">    :rtype: str, str, str, str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># load all the trials if loading trials (input)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">do_load_trials</span><span class="p">:</span>

        <span class="n">loaded_trials</span><span class="p">,</span> <span class="n">fname_load_trials</span><span class="p">,</span> <span class="n">max_batch_size</span> \
            <span class="o">=</span> <span class="n">load_trials_for_batches</span><span class="p">(</span><span class="n">fname_load_trials_base</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># start testing</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loaded_trials</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_days</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">x</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_num_steps</span><span class="p">()</span>
            <span class="n">x</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_no_variation</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># end testing</span>
        <span class="c1">#</span>
        <span class="n">num_days</span>    <span class="o">=</span> <span class="n">loaded_trials</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_days</span>
        <span class="n">num_hhld</span>    <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_trials</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_batch_size</span> <span class="o">=</span> <span class="n">get_max_batch_size</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">)</span>

    <span class="c1">#  print starting information</span>
    <span class="n">print_starting_info</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">num_process</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>

    <span class="c1"># create the file names for saving files</span>
    <span class="n">fname_trials</span><span class="p">,</span> <span class="n">fname_data</span><span class="p">,</span> <span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">fname_data_base</span> <span class="o">=</span> \
        <span class="n">get_fnames</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">demographic</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">num_hhld</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># loop through batches</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batch</span><span class="p">):</span>

        <span class="c1"># the number of households to simulate for the current batch</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">get_current_batch_size</span><span class="p">(</span><span class="n">num_hhld</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># set the trials (input)</span>
        <span class="c1">#</span>

        <span class="c1"># load the trials data</span>
        <span class="k">if</span> <span class="n">do_load_trials</span><span class="p">:</span>

            <span class="c1"># load the trials data for this batch</span>
            <span class="n">trials</span> <span class="o">=</span> <span class="n">get_loaded_trials_for_batch</span><span class="p">(</span><span class="n">loaded_trials</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># if not loading pre-existing trials data, create trials data for this batch</span>
            <span class="n">trials</span> <span class="o">=</span> <span class="n">create_trials</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="n">num_hours</span><span class="p">,</span> <span class="n">num_min</span><span class="p">,</span> <span class="n">trial_code</span><span class="p">,</span> \
                                   <span class="n">chad_activity_params</span><span class="p">,</span> <span class="n">demographic</span><span class="p">,</span> <span class="n">num_people</span><span class="p">,</span> \
                                   <span class="n">do_minute_by_minute</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># set the file names for saving data for this batch</span>
        <span class="c1">#</span>

        <span class="c1"># set the file names for the save files for the current batch</span>
        <span class="n">fname_save_trials</span><span class="p">,</span> <span class="n">fname_save_data</span> \
            <span class="o">=</span> <span class="n">set_save_files_for_batch</span><span class="p">(</span><span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">fname_data_base</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># run the simulation</span>
        <span class="c1">#</span>

        <span class="n">result</span><span class="p">,</span> <span class="n">param_list</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">num_process</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># save the data from the batch as a .pkl file</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="n">do_save</span><span class="p">:</span>
            <span class="n">save_for_batch</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">fname_save_trials</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>
            <span class="n">save_for_batch</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fname_save_data</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fname_trials</span><span class="p">,</span> <span class="n">fname_data</span><span class="p">,</span> <span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">fname_data_base</span></div>

<div class="viewcode-block" id="run_parallel"><a class="viewcode-back" href="../driver.html#driver.run_parallel">[docs]</a><span class="k">def</span> <span class="nf">run_parallel</span><span class="p">(</span><span class="n">num_process</span><span class="p">,</span> <span class="n">trials</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function runs the simulation in parallel.</span>

<span class="sd">    :param int num_process: the number of processors used</span>
<span class="sd">    :param trials: the input data</span>
<span class="sd">    :type trials: list of :class:`trial.Trial`</span>

<span class="sd">    :returns: the output of the simulations</span>
<span class="sd">    :rtype: list of :class:`diary.Diary`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pool the threads</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_process</span><span class="p">)</span>

    <span class="c1"># the simulation data for each simulation</span>
    <span class="n">diaries</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">run_trials_parallel</span><span class="p">,</span> <span class="n">trials</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">diaries</span></div>

<div class="viewcode-block" id="run_serial"><a class="viewcode-back" href="../driver.html#driver.run_serial">[docs]</a><span class="k">def</span> <span class="nf">run_serial</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function runs the simulation in serial.</span>

<span class="sd">    :param trials: the input data</span>
<span class="sd">    :type trials: list of :class:`trial.Trial`</span>
<span class="sd">    :param bool do_print: a flag whether or not to print the trial number</span>

<span class="sd">    :returns: the output of the simulations</span>
<span class="sd">    :rtype: list of :class:`diary.Diary`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">diaries</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># loop through each simulation</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trial: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">diaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">diaries</span></div>

<div class="viewcode-block" id="run_trials_parallel"><a class="viewcode-back" href="../driver.html#driver.run_trials_parallel">[docs]</a><span class="k">def</span> <span class="nf">run_trials_parallel</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called in order to run the trials in parallel.</span>

<span class="sd">    :param trial.Trial t: the trial to run</span>

<span class="sd">    :return: the results of the simulation</span>
<span class="sd">    :rtype: diary.Diary</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># run the simulation</span>
    <span class="n">diary_hhld</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">diary_hhld</span></div>

<div class="viewcode-block" id="save"><a class="viewcode-back" href="../driver.html#driver.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">fname_data</span><span class="p">,</span> <span class="n">fname_trials</span><span class="p">,</span> <span class="n">fname_data_base</span><span class="p">,</span> <span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function saves the input and output from the simulation. It merges \</span>
<span class="sd">    the data from the batch save files into one file for not only the \</span>
<span class="sd">    trials data (input) but also the ABMHAP simulation data (output). Afterwards, \</span>
<span class="sd">    the individual batch files are deleted.</span>

<span class="sd">    :param str fname_data: the file name in which to save the ABMHAP data (output)</span>
<span class="sd">    :param str fname_trials: the file name in which to save the ABMHAP trials (input)</span>
<span class="sd">    :param str fname_data_base: the base (no &quot;.pkl&quot; extension) of the file name in \</span>
<span class="sd">    which to save the ABMHAP data (output)</span>
<span class="sd">    :param str fname_trials_base: the base (no &quot;.pkl&quot; extension) of file name in \</span>
<span class="sd">    which to save the ABMHAP trials (input)</span>
<span class="sd">    :param bool do_print: print flag</span>


<span class="sd">    :returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># save the batch files as 1 unit</span>
    <span class="n">save_batch_data_as_one_file</span><span class="p">(</span><span class="n">fname_data</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>
    <span class="n">save_batch_trials_as_one_file</span><span class="p">(</span><span class="n">fname_trials</span><span class="p">,</span> <span class="n">do_print</span><span class="p">)</span>

    <span class="c1"># clean up the batch files</span>
    <span class="n">delete_batch_files</span><span class="p">(</span><span class="n">fname_data_base</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">)</span>
    <span class="n">delete_batch_files</span><span class="p">(</span><span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">)</span>

    <span class="c1"># save the data as a .csv</span>
    <span class="n">save_diary_to_csv</span><span class="p">(</span><span class="n">fname_data</span><span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="save_batch_data_as_one_file"><a class="viewcode-back" href="../driver.html#driver.save_batch_data_as_one_file">[docs]</a><span class="k">def</span> <span class="nf">save_batch_data_as_one_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function combines the ABMHAP data from the individual batch saves and saves them in one file.</span>

<span class="sd">    :param str fname: the file name of the ABMHAP data (.pkl)</span>

<span class="sd">    :returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the file path</span>
    <span class="n">fpath</span>       <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="c1"># take the file name without the path</span>
    <span class="n">f_name</span>      <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fpath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get the batch file names</span>
    <span class="n">fname_list</span>  <span class="o">=</span> <span class="n">get_batch_filenames</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">f_name</span><span class="p">)</span>

    <span class="c1"># get the data</span>
    <span class="n">data_list</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">mg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">]</span>

    <span class="c1"># save the results</span>
    <span class="n">result</span>      <span class="o">=</span> <span class="n">driver_result</span><span class="o">.</span><span class="n">Batch_Result</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

    <span class="c1"># saving message</span>
    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="n">msg</span>         <span class="o">=</span> <span class="s1">&#39;saving all batch data....</span><span class="se">\n</span><span class="s1">File name: </span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># save the data</span>
    <span class="n">mg</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="save_batch_trials_as_one_file"><a class="viewcode-back" href="../driver.html#driver.save_batch_trials_as_one_file">[docs]</a><span class="k">def</span> <span class="nf">save_batch_trials_as_one_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function combines the trial (input) data from the individual \</span>
<span class="sd">    batch saves and saves them in one file.</span>

<span class="sd">    :param str fname: the file name of the trials data (.pkl)</span>
<span class="sd">    :param bool do_print: print flag</span>

<span class="sd">    :returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the file path</span>
    <span class="n">fpath</span>       <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="n">f_name</span>      <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fpath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get the batch filen ames</span>
    <span class="n">fname_list</span>  <span class="o">=</span> <span class="n">get_batch_filenames</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">f_name</span><span class="p">)</span>

    <span class="c1"># get the data</span>
    <span class="n">trials_list</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">mg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">]</span>

    <span class="c1"># save the results</span>
    <span class="n">trials</span> <span class="o">=</span> <span class="p">[</span> <span class="n">subitem</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">trials_list</span> <span class="k">for</span> <span class="n">subitem</span> <span class="ow">in</span> <span class="n">item</span> <span class="p">]</span>

    <span class="c1"># saving message</span>
    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="n">msg</span>         <span class="o">=</span> <span class="s1">&#39;saving all batch trials....</span><span class="se">\n</span><span class="s1">File name: </span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># save the data</span>
    <span class="n">mg</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="save_diary_to_csv"><a class="viewcode-back" href="../driver.html#driver.save_diary_to_csv">[docs]</a><span class="k">def</span> <span class="nf">save_diary_to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function loads an activity diary from a compressed file format \</span>
<span class="sd">    and saves it as a .csv file.</span>

<span class="sd">    :param str fname: the pickle file that holds the activity diary file.</span>

<span class="sd">    :returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load the data as driver_rest.Driver_Result object</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="c1"># acceptable extensions for pickle files</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">EXTENSION_PKL</span>

    <span class="c1"># set the file name to .csv</span>
    <span class="n">fname_csv</span> <span class="o">=</span> <span class="p">[</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extensions</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fname</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># save the diary as a .csv file</span>
    <span class="n">mg</span><span class="o">.</span><span class="n">save_diary_to_csv</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">get_combined_diary</span><span class="p">(),</span> <span class="n">fname_csv</span><span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="save_for_batch"><a class="viewcode-back" href="../driver.html#driver.save_for_batch">[docs]</a><span class="k">def</span> <span class="nf">save_for_batch</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the data for the current batch.</span>

<span class="sd">    :param driver_result.Driver_Result result: the result of the simulation for the current batch</span>
<span class="sd">    :param str fname: the file name to save the data for the current batch</span>
<span class="sd">    :param bool do_print: print flag</span>

<span class="sd">    :returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># save the data from the batch as a .pkl file</span>
    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;saving data....</span><span class="se">\n</span><span class="s1">File name: </span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># save the data in compressed form</span>
    <span class="n">mg</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="set_save_files_for_batch"><a class="viewcode-back" href="../driver.html#driver.set_save_files_for_batch">[docs]</a><span class="k">def</span> <span class="nf">set_save_files_for_batch</span><span class="p">(</span><span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">fname_data_base</span><span class="p">,</span>  <span class="n">i</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function sets the save files (inputs and output files) for the current batch.</span>

<span class="sd">    :param str fname_trials_base: the file name for the ABMHAP data without the .pkl, \</span>
<span class="sd">    which will be used for saving the input data (.pkl)</span>
<span class="sd">    :param str fname_data_base: the file name for the ABMHAP data without the .pkl, \</span>
<span class="sd">    which will be used for saving the output data (.pkl)</span>
<span class="sd">    :param int i: the current batch index</span>
<span class="sd">    :param bool do_print: flag indicating whether or not to print relevant \</span>
<span class="sd">    information to the console</span>

<span class="sd">    :returns: the save file name for the input data, \</span>
<span class="sd">    the save file name for the output data</span>
<span class="sd">    :rtype: str, str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the file ending used for batch saves</span>
    <span class="n">file_ending</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">F_BATCH_ENDING</span> <span class="o">%</span> <span class="n">i</span>

    <span class="c1"># the file name of the trials for the current batch</span>
    <span class="n">fname_save_trials</span> <span class="o">=</span> <span class="n">fname_trials_base</span> <span class="o">+</span> <span class="n">file_ending</span>

    <span class="c1"># the file name of the results data for the current batch</span>
    <span class="n">fname_save_data</span> <span class="o">=</span> <span class="n">fname_data_base</span> <span class="o">+</span> <span class="n">file_ending</span>

    <span class="c1"># print the batch number and the file name for both the trials and the data from the ABM</span>
    <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Batch number: </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname_save_trials</span><span class="p">,</span> <span class="n">fname_save_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fname_save_trials</span><span class="p">,</span> <span class="n">fname_save_data</span></div>

<div class="viewcode-block" id="set_save_path"><a class="viewcode-back" href="../driver.html#driver.set_save_path">[docs]</a><span class="k">def</span> <span class="nf">set_save_path</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">num_days</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function sets the save path for the data. Given a save path, the function appends it by adding an \</span>
<span class="sd">    extension of the current year, month, day, number of households, and number of days in the format.</span>

<span class="sd">    For example, if this code is being run to simulate 64 households for 100 days on July 4, 2017 and the \</span>
<span class="sd">    file path is &quot;output_path&quot;, the file path is set to the following: //output_path//2017_07_04//n0064_d100.</span>

<span class="sd">    :param str fpath: the file path in which to save the data</span>
<span class="sd">    :param int N: the number of households</span>
<span class="sd">    :param int num_days: the number of days in the simulation</span>


<span class="sd">    :returns: the file directory in the format &#39;//output_file_path//YYYY_MM_DD//nXXXX_dXXX&#39;</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get today&#39;s date</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

    <span class="c1"># set file path with the appropriate ending</span>
    <span class="n">fpath_data</span> <span class="o">=</span> <span class="n">fpath</span> <span class="o">+</span> <span class="p">(</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="si">%04d</span><span class="s1">_</span><span class="si">%02d</span><span class="s1">_</span><span class="si">%02d</span><span class="se">\\</span><span class="s1">n</span><span class="si">%04d</span><span class="s1">_d</span><span class="si">%03d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">fpath_data</span></div>

<div class="viewcode-block" id="run_everything"><a class="viewcode-back" href="../driver.html#driver.run_everything">[docs]</a><span class="k">def</span> <span class="nf">run_everything</span><span class="p">(</span><span class="n">num_process</span><span class="p">,</span> <span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This code runs the Monte-Carlo simulations. More specifically, it</span>

<span class="sd">    #. creates / loads the input data</span>
<span class="sd">    #. runs the simulations</span>
<span class="sd">    #. saves both the input and output data</span>

<span class="sd">    :param int num_process: the number of processes</span>
<span class="sd">    :param int num_hhld: the number of households per core per batch</span>
<span class="sd">    :param int num_batch: the number of batches</span>

<span class="sd">    :return: the file name for the input data, the file name for the output data</span>
<span class="sd">    :rtype: str, str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Run the code</span>
    <span class="c1">#</span>

    <span class="c1"># chad demographic</span>
    <span class="n">chad_demo</span> <span class="o">=</span> <span class="n">get_chad_demo</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">demographic</span><span class="p">)</span>

    <span class="c1"># print starting message</span>
    <span class="n">print_start</span><span class="p">()</span>

    <span class="c1"># start timing the simulation</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">fname_trials</span><span class="p">,</span> <span class="n">fname_data</span><span class="p">,</span> <span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">fname_data_base</span> \
        <span class="o">=</span> <span class="n">run_batch</span><span class="p">(</span><span class="n">num_batch</span><span class="p">,</span> <span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_process</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">num_days</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">num_hours</span><span class="p">,</span> \
                    <span class="n">dp</span><span class="o">.</span><span class="n">num_min</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">trial_code</span><span class="p">,</span> <span class="n">chad_demo</span><span class="o">.</span><span class="n">int_2_param</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">demographic</span><span class="p">,</span> \
                    <span class="n">dp</span><span class="o">.</span><span class="n">num_people</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">do_minute_by_minute</span><span class="p">,</span> \
                    <span class="n">dp</span><span class="o">.</span><span class="n">do_print</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">do_save</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">fpath</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">do_load_trials</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">fname_load_trials_base</span><span class="p">)</span>

    <span class="c1"># end timing the simulation</span>
    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span>

    <span class="c1">#</span>
    <span class="c1"># print ending statement</span>
    <span class="c1">#</span>
    <span class="n">print_end</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Batch Save</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">dp</span><span class="o">.</span><span class="n">do_save</span><span class="p">:</span>

        <span class="c1"># save the data</span>
        <span class="n">save</span><span class="p">(</span><span class="n">fname_data</span><span class="p">,</span> <span class="n">fname_trials</span><span class="p">,</span> <span class="n">fname_data_base</span><span class="p">,</span> <span class="n">fname_trials_base</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">fname_trials</span><span class="p">,</span> <span class="n">fname_data</span></div>

<span class="c1"># ===========================================</span>
<span class="c1"># run</span>
<span class="c1"># ===========================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1">#</span>
    <span class="c1"># command line parameters</span>
    <span class="c1">#</span>

    <span class="c1"># get monte-carlo parameters from command line</span>
    <span class="n">num_process</span><span class="p">,</span> <span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_batch</span> <span class="o">=</span> <span class="n">get_cmd_line_params</span><span class="p">()</span>

    <span class="c1"># run the simulations</span>
    <span class="n">run_everything</span><span class="p">(</span><span class="n">num_process</span><span class="p">,</span> <span class="n">num_hhld</span><span class="p">,</span> <span class="n">num_batch</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Namdi Brandon.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>